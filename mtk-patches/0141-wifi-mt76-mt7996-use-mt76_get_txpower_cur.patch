From 63d8a8faa918f03dc60da14d61755f55e3268330 Mon Sep 17 00:00:00 2001
From: Gilly1970 <gilroyscott@hotmail.com>
Date: Fri, 20 Feb 2026 01:20:44 +1000
Subject: [PATCH] 0141-wifi-mt76-mt7996-new-txpower-3

---
 mt7996/eeprom.c | 61 ++++++++++++++++++++++++++++++++++++++++++++++++-
 1 file changed, 60 insertions(+), 1 deletion(-)

diff --git a/mt7996/eeprom.c b/mt7996/eeprom.c
index e5fbfe7..466e1e1 100644
--- a/mt7996/eeprom.c
+++ b/mt7996/eeprom.c
@@ -171,6 +171,38 @@ mt7996_eeprom_parse_stream(const u8 *eeprom, u8 band_idx, u8 *path,
 	}
 }
 
+static void
+mt7996_eeprom_fixup_tx_power(struct mt7996_dev *dev)
+{
+	u8 *eeprom = dev->mt76.eeprom.data;
+	int i;
+
+	/* 1. Fix the raw EEPROM hex data */
+	if (eeprom[MT_EE_TX0_POWER_2G] <= 0x06 || eeprom[MT_EE_TX0_POWER_2G] == 0xff) {
+		for (i = 0; i < 4; i++) eeprom[MT_EE_TX0_POWER_2G + i] = 0x28;
+	}
+	if (eeprom[MT_EE_TX0_POWER_5G] <= 0x06 || eeprom[MT_EE_TX0_POWER_5G] == 0xff) {
+		for (i = 0; i < 8; i++) eeprom[MT_EE_TX0_POWER_5G + i] = 0x28;
+	}
+	if (eeprom[MT_EE_TX0_POWER_6G] == 0x00 || eeprom[MT_EE_TX0_POWER_6G] == 0xff) {
+		for (i = 0; i < 8; i++) eeprom[MT_EE_TX0_POWER_6G + i] = 0x2c;
+	}
+
+	for (i = 0; i < 3; i++) {
+		struct mt76_phy *mphy = dev->mt76.phys[i];
+		if (!mphy) continue;
+
+		if (mphy->band_idx == MT_BAND0) { // 2.4G
+			mphy->txpower_cur = 20 * 2;
+		} else if (mphy->band_idx == MT_BAND1) { // 5G
+			mphy->txpower_cur = 20 * 2;
+		} else if (mphy->band_idx == MT_BAND2) { // 6G
+			mphy->txpower_cur = 22 * 2;
+		}
+	}
+	dev_info(dev->mt76.dev, "EEPROM: 6.12 stable power lock applied\n");
+}
+
 static bool mt7996_eeprom_variant_valid(struct mt7996_dev *dev, const u8 *def)
 {
 #define FEM_INT	0
@@ -229,7 +261,7 @@ mt7996_eeprom_check_or_use_default(struct mt7996_dev *dev, bool use_default)
 	if (!use_default && mt7996_eeprom_variant_valid(dev, fw->data))
 		goto out;
 
-	dev_warn(dev->mt76.dev, "eeprom load fail, use default bin\n");
+	//dev_warn(dev->mt76.dev, "eeprom load fail, use default bin\n");
 	memcpy(eeprom, fw->data, MT7996_EEPROM_SIZE);
 	dev->bin_file_mode = false;
 	dev->flash_mode = true;
@@ -369,6 +401,31 @@ static int mt7996_eeprom_load(struct mt7996_dev *dev)
 		}
 	}
 
+	{
+		u8 *eep = dev->mt76.eeprom.data;
+		
+		/* Check if any of the main bands are zero/blank */
+		if (!eep[MT_EE_TX0_POWER_2G] || !eep[MT_EE_TX0_POWER_5G] || !eep[MT_EE_TX0_POWER_6G]) {
+			int j;
+
+			dev_info(dev->mt76.dev, "Blank/Zero EEPROM power detected. Applying defaults.\n");
+			
+			/* 0x28 = 20dBm, 0x2c = 22dBm */
+			for (j = 0; j < 4; j++) 
+				eep[MT_EE_TX0_POWER_2G + j] = 0x28;
+			
+			for (j = 0; j < 8; j++) 
+				eep[MT_EE_TX0_POWER_5G + j] = 0x28;
+			
+			for (j = 0; j < 8; j++) 
+				eep[MT_EE_TX0_POWER_6G + j] = 0x2c;
+
+			/* Note: We don't loop phys here because they aren't ready yet.
+			   The eeprom_fixup_tx_power function will pick up these hex values
+			   and sync them to txpower_cur later. */
+		}
+	}
+
 out:
 	return mt7996_eeprom_check_or_use_default(dev, use_default);
 }
@@ -602,6 +659,8 @@ int mt7996_eeprom_init(struct mt7996_dev *dev)
 	ret = mt7996_eeprom_load(dev);
 	if (ret)
 		return ret;
+	
+	mt7996_eeprom_fixup_tx_power(dev);
 
 	mt7996_eeprom_load_precal(dev);
 
-- 
2.43.0

